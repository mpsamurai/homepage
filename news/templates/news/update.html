{% extends "news_update.html" %}

{% load static %}

{% block content %}


<section>
    <form action="" method="post">
        {% csrf_token %}

        {% for field in form %}
            {% if field.html_name == 'image' %}
                <!-- <img id="update_image" src="{% get_media_prefix %}/{{ field.value }}" alt=""> -->



                <div style="position: relative;">
                    <canvas id="base_image" width="1680" height="1050" style="position: relative; z-index: 1;"></canvas>
                    <img id="update_image" style="position: absolute; top: 0; left: 0;" src="{% get_media_prefix %}/{{ field.value }}" alt="">
                </div>
                <div>
                    <canvas id="trimming_image" width="1680" height="1050"></canvas>
                </div>

                {{ field }}

                <script>

/*
                    var obj1 = document.getElementById("id_image");
                       obj1.addEventListener("change", function(evt){
                          var file = evt.target.files;
                          var reader = new FileReader();

                          //dataURL形式でファイルを読み込む
                          reader.readAsDataURL(file[0]);

                          //ファイルの読込が終了した時の処理
                          reader.onload = function(){
                            var dataUrl = reader.result;

                            //読み込んだ画像とdataURLを書き出す
                            document.getElementById("update_image").src = dataUrl;
                          }
                    },false);
*/


                    const baseImage = document.getElementById("id_image");
                    baseImage.addEventListener("change", function(e){
                        const file = e.target.files;
                        const reader = new FileReader();

                        //dataURL形式でファイルを読み込む
                        reader.readAsDataURL(file[0]);

                        //ファイルの読込が終了した時の処理
                        reader.onload = function(){
                            const dataUrl = reader.result;

                            //読み込んだ画像とdataURLを書き出す
                            document.getElementById("update_image").src = dataUrl;

                            var test = document.getElementById("update_image").src;
                        }
                    },false);



                </script>




<script>


(function() {


/*
    var items = [1,2,3,4,5];

    var result = items.map(function( value ) {

        return value * 2;

    });

    console.log( result );
*/



})();



class Clipper {

    constructor() {
        this.startX;
        this.startY;
        this.endX;
        this.endY;
        this.viewerList = [];
        this.canvas = document.getElementById('base_image');
        this.ctx = this.canvas.getContext('2d');
        this.ctx.strokeStyle = "blue";
    }

    addViewer(obj) {
        this.viewerList.push(obj);
    }

    notifyViewers(_ctx, _startX, _startY, _endX, _endY) {
        this.viewerList.map(function(element) {
            element.update(_ctx, _startX, _startY, _endX, _endY);
        });
    }

    clipImage() {
        document.addEventListener("mousedown", (e) => {
            console.log(this.canvas);
            this.startX = this.getCoordinate(e.pageX, this.canvas.offsetLeft);
            this.startY = this.getCoordinate(e.pageY, this.canvas.offsetTop);
            document.addEventListener("mousemove", keyMove);
        });

        document.addEventListener("mouseup", (e) => {
            this.endX = this.getCoordinate(e.pageX, this.canvas.offsetLeft);
            this.endY = this.getCoordinate(e.pageY, this.canvas.offsetTop);
            this.drawRectangle(this.ctx);
            removeHandler();
            this.notifyViewers(this.ctx, this.startX, this.startY, this.endX, this.endY);
        });

        const keyMove = (e) => {
            this.endX = this.getCoordinate(e.pageX, this.canvas.offsetLeft);
            this.endY = this.getCoordinate(e.pageY, this.canvas.offsetTop);
            console.log(this.endX, this.endY);
            this.clearRectangle(this.ctx);
            this.drawRectangle(this.ctx);
        }

        const removeHandler = () => {
            document.removeEventListener("mousemove", keyMove);
        }

    }

    getCoordinate(_coordinateVal, _offsetVal) {
        return _coordinateVal - _offsetVal;
    };

    drawRectangle(_ctx) {
        _ctx.strokeRect(this.startX, this.startY, this.endX - this.startX, this.endY - this.startY);
    }

    clearRectangle(_ctx) {
        _ctx.clearRect(0, 0, this.canvas.clientWidth, this.canvas.clientHeight);
    }
}

class Viewer {

    constructor() {
        this.img = new Image();
        this.canvas = document.getElementById('trimming_image');
        this.ctx = this.canvas.getContext('2d');
    }

    update(clipperCtx, _startX, _startY, _endX, _endY) {
        // this.img.src = '{% get_media_prefix %}/{{ field.value }}';
        this.img.src = '{% get_media_prefix %}/{{ field.value }}';
        console.log(clipperCtx.canvas.id);
        this.ctx.clearRect(0, 0, this.canvas.clientWidth, this.canvas.clientHeight);
        this.ctx.drawImage(this.img, _startX, _startY, _endX - _startX, _endY - _startY, 0, 0, _endX - _startX, _endY - _startY);
    }
}

const clipper1 = new Clipper();
const viewer1 = new Viewer();

clipper1.addViewer(viewer1);
clipper1.clipImage();

















/*
    let startX;
    let startY;
    let endX;
    let endY;

    document.addEventListener("mousedown", (e) => {
        let canvas = document.getElementById('base_image');

        startX = e.pageX - canvas.offsetLeft;
        startY = e.pageY - canvas.offsetTop;

        console.log(startX, startY);
        document.addEventListener("mousemove", keyMove);
    });

    document.addEventListener("mouseup", (e) => {
        console.log("up");

        drawSlice();

        removeHandler();
    });

    let keyMove = (e) => {
        console.log("move");
        let canvas = document.getElementById('base_image');
        let ctx = canvas.getContext('2d');

        endX = e.pageX - canvas.offsetLeft;
        endY = e.pageY - canvas.offsetTop;



        ctx.strokeStyle="blue";
        ctx.beginPath();
        ctx.clearRect(0, 0, 10000, 10000);
        ctx.strokeRect(startX, startY, endX - startX, endY - startY);


    }

    let removeHandler = () => {
      document.removeEventListener("mousemove", keyMove);
    }

    function draw() {
      var ctx = document.getElementById('base_image').getContext('2d');
      var img = new Image();
      img.onload = function(){
        ctx.drawImage(img, 0, 0);
      };
      img.src = 'profile.png';
    }

    function drawSlice() {
      var ctx = document.getElementById('trimming_image').getContext('2d');
      var img = new Image();
      // img.src = '{% get_media_prefix %}/{{ field.value }}';
      img.src = '{% get_media_prefix %}/{{ field.value }}';

      img.onload = function(){
        ctx.drawImage(img, startX, startY, endX - startX, endY - startY, 0, 0, endX - startX, endY - startY);
      };
      img.src = '{% get_media_prefix %}/{{ field.value }}';
    }
*/





</script>




















            {% elif field.html_name == 'thumbnail' %}
                <img src="{% get_media_prefix %}/{{ field.value }}" alt="">
                {{ field }}
            {% elif field.html_name == 'created_date' %}
                <p>created_date</p>
            {% elif field.html_name == 'title' %}
                <p>{{ field.value }}</p>
            {% elif field.html_name == 'article' %}
                <p>{{ field.value }}</p>
            {% elif field.html_name == 'tags' %}
                <p>{{ field.value }}</p>
            {% endif %}
        {% endfor %}

        <button type="submit">Update</button>
    </form>
</section>
{% endblock %}

